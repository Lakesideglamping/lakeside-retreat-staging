<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Lakeside Retreat Admin</title>
    <link rel="stylesheet" href="/admin-shell.css?v=2">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .alerts-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .alert-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid transparent;
        }
        
        .alert-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .alert-card.critical {
            border-left-color: #dc3545;
        }
        
        .alert-card.warning {
            border-left-color: #ffc107;
        }
        
        .alert-card.info {
            border-left-color: #17a2b8;
        }
        
        .alert-card.success {
            border-left-color: #28a745;
        }
        
        .alert-count {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .alert-card.critical .alert-count { color: #dc3545; }
        .alert-card.warning .alert-count { color: #ffc107; }
        .alert-card.info .alert-count { color: #17a2b8; }
        .alert-card.success .alert-count { color: #28a745; }
        
        .alert-label {
            color: #666;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .notifications-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .section-header {
            background: linear-gradient(135deg, #2d5a5a 0%, #1e4040 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h2 {
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-header .badge {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }
        
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            transition: background 0.2s;
        }
        
        .notification-item:hover {
            background: #f8f9fa;
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .notification-icon.critical {
            background: #f8d7da;
            color: #dc3545;
        }
        
        .notification-icon.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .notification-icon.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .notification-icon.success {
            background: #d4edda;
            color: #155724;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .notification-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .notification-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #999;
        }
        
        .notification-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .btn {
            background: #2d5a5a;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #1e4040;
        }
        
        .btn-sm {
            padding: 0.35rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #2d5a5a;
            color: #2d5a5a;
        }
        
        .btn-outline:hover {
            background: #2d5a5a;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #2d5a5a;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }
        
        .refresh-btn:hover {
            transform: rotate(180deg);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .notification-item {
                flex-direction: column;
            }
            
            .notification-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Alerts Summary -->
        <div class="alerts-summary">
            <div class="alert-card critical" onclick="scrollToSection('critical')">
                <div class="alert-count" id="criticalCount">-</div>
                <div class="alert-label">Critical Issues</div>
            </div>
            <div class="alert-card warning" onclick="scrollToSection('warnings')">
                <div class="alert-count" id="warningCount">-</div>
                <div class="alert-label">Warnings</div>
            </div>
            <div class="alert-card info" onclick="scrollToSection('pending')">
                <div class="alert-count" id="pendingCount">-</div>
                <div class="alert-label">Pending Actions</div>
            </div>
            <div class="alert-card success" onclick="scrollToSection('resolved')">
                <div class="alert-count" id="resolvedCount">-</div>
                <div class="alert-label">Resolved Today</div>
            </div>
        </div>
        
        <!-- Critical Issues Section -->
        <div class="notifications-section" id="critical">
            <div class="section-header">
                <h2><span>Critical Issues</span></h2>
                <span class="badge" id="criticalBadge">0 items</span>
            </div>
            <div class="notification-list" id="criticalList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Warnings Section -->
        <div class="notifications-section" id="warnings">
            <div class="section-header" style="background: linear-gradient(135deg, #856404 0%, #ffc107 100%);">
                <h2><span>Warnings</span></h2>
                <span class="badge" id="warningBadge">0 items</span>
            </div>
            <div class="notification-list" id="warningList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Pending Actions Section -->
        <div class="notifications-section" id="pending">
            <div class="section-header" style="background: linear-gradient(135deg, #0c5460 0%, #17a2b8 100%);">
                <h2><span>Pending Actions</span></h2>
                <span class="badge" id="pendingBadge">0 items</span>
            </div>
            <div class="notification-list" id="pendingList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Resolved Section -->
        <div class="notifications-section" id="resolved">
            <div class="section-header" style="background: linear-gradient(135deg, #155724 0%, #28a745 100%);">
                <h2><span>Resolved Today</span></h2>
                <span class="badge" id="resolvedBadge">0 items</span>
            </div>
            <div class="notification-list" id="resolvedList">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Refresh Button -->
    <button class="refresh-btn" onclick="loadNotifications()" title="Refresh Notifications">
        <span>&#x21bb;</span>
    </button>

    <script>
        // Check authentication
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin.html';
        }

        // Notification data
        let notifications = {
            critical: [],
            warnings: [],
            pending: [],
            resolved: []
        };

        // Load notifications from various sources
        async function loadNotifications() {
            try {
                // Fetch data from multiple endpoints
                const [bookingsRes, abandonedRes, statsRes] = await Promise.all([
                    fetch('/api/admin/bookings?limit=100', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/admin/marketing/abandoned-checkouts', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/admin/booking-stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                let bookings = [];
                let abandonedCheckouts = [];
                let stats = {};

                if (bookingsRes.ok) {
                    const data = await bookingsRes.json();
                    bookings = data.bookings || [];
                }

                if (abandonedRes.ok) {
                    const data = await abandonedRes.json();
                    abandonedCheckouts = data.abandonedCheckouts || [];
                }

                if (statsRes.ok) {
                    stats = await statsRes.json();
                }

                // Process notifications
                processNotifications(bookings, abandonedCheckouts, stats);
                
            } catch (error) {
                console.error('Error loading notifications:', error);
                showEmptyState('criticalList', 'Unable to load notifications');
                showEmptyState('warningList', 'Unable to load notifications');
                showEmptyState('pendingList', 'Unable to load notifications');
                showEmptyState('resolvedList', 'Unable to load notifications');
            }
        }

        function processNotifications(bookings, abandonedCheckouts, stats) {
            notifications = {
                critical: [],
                warnings: [],
                pending: [],
                resolved: []
            };

            const now = new Date();
            const today = now.toISOString().split('T')[0];

            // Check for failed payments (critical)
            bookings.filter(b => b.payment_status === 'failed').forEach(booking => {
                notifications.critical.push({
                    type: 'failed_payment',
                    title: 'Failed Payment',
                    description: `Payment failed for ${booking.guest_name} - ${booking.accommodation}`,
                    meta: { bookingId: booking.id, amount: booking.total_price },
                    time: booking.updated_at || booking.created_at,
                    actions: [
                        { label: 'View Booking', action: () => viewBooking(booking.id) },
                        { label: 'Retry Payment', action: () => retryPayment(booking.id), type: 'warning' }
                    ]
                });
            });

            // Check for sync failures (critical)
            bookings.filter(b => b.payment_status === 'completed' && !b.uplisting_id).forEach(booking => {
                notifications.critical.push({
                    type: 'sync_failure',
                    title: 'Uplisting Sync Failed',
                    description: `Booking #${booking.id} for ${booking.guest_name} not synced to Uplisting`,
                    meta: { bookingId: booking.id },
                    time: booking.updated_at || booking.created_at,
                    actions: [
                        { label: 'Retry Sync', action: () => retrySync(booking.id) },
                        { label: 'View Details', action: () => viewBooking(booking.id), type: 'outline' }
                    ]
                });
            });

            // Check for abandoned checkouts (warning)
            abandonedCheckouts.forEach(checkout => {
                notifications.warnings.push({
                    type: 'abandoned_checkout',
                    title: 'Abandoned Checkout',
                    description: `${checkout.guest_email || 'Guest'} abandoned checkout for ${checkout.accommodation}`,
                    meta: { checkoutId: checkout.id, amount: checkout.total_price },
                    time: checkout.created_at,
                    actions: [
                        { label: 'Send Reminder', action: () => sendReminder(checkout.id), type: 'warning' },
                        { label: 'View Details', action: () => viewAbandonedCheckout(checkout.id), type: 'outline' }
                    ]
                });
            });

            // Check for pending bookings (pending actions)
            bookings.filter(b => b.status === 'pending' && b.payment_status === 'pending').forEach(booking => {
                notifications.pending.push({
                    type: 'pending_booking',
                    title: 'Pending Booking',
                    description: `${booking.guest_name} - awaiting payment for ${booking.accommodation}`,
                    meta: { bookingId: booking.id, amount: booking.total_price },
                    time: booking.created_at,
                    actions: [
                        { label: 'View Booking', action: () => viewBooking(booking.id) },
                        { label: 'Send Payment Link', action: () => sendPaymentLink(booking.id), type: 'outline' }
                    ]
                });
            });

            // Check for today's check-ins (pending actions)
            bookings.filter(b => b.check_in === today && b.status === 'confirmed').forEach(booking => {
                notifications.pending.push({
                    type: 'today_checkin',
                    title: "Today's Check-in",
                    description: `${booking.guest_name} checking into ${booking.accommodation}`,
                    meta: { bookingId: booking.id, guests: booking.guests },
                    time: booking.check_in,
                    actions: [
                        { label: 'View Details', action: () => viewBooking(booking.id) },
                        { label: 'Send Welcome', action: () => sendWelcome(booking.id), type: 'outline' }
                    ]
                });
            });

            // Check for today's check-outs (pending actions)
            bookings.filter(b => b.check_out === today && b.status === 'confirmed').forEach(booking => {
                notifications.pending.push({
                    type: 'today_checkout',
                    title: "Today's Check-out",
                    description: `${booking.guest_name} checking out of ${booking.accommodation}`,
                    meta: { bookingId: booking.id },
                    time: booking.check_out,
                    actions: [
                        { label: 'View Details', action: () => viewBooking(booking.id) },
                        { label: 'Request Review', action: () => requestReview(booking.id), type: 'outline' }
                    ]
                });
            });

            // Simulated resolved items (in production, track actual resolutions)
            const recentConfirmed = bookings.filter(b => {
                const createdDate = new Date(b.created_at);
                const hoursDiff = (now - createdDate) / (1000 * 60 * 60);
                return b.status === 'confirmed' && b.payment_status === 'completed' && hoursDiff < 24;
            });

            recentConfirmed.forEach(booking => {
                notifications.resolved.push({
                    type: 'booking_confirmed',
                    title: 'Booking Confirmed',
                    description: `${booking.guest_name} - ${booking.accommodation} confirmed and synced`,
                    meta: { bookingId: booking.id, amount: booking.total_price },
                    time: booking.updated_at || booking.created_at,
                    actions: [
                        { label: 'View Booking', action: () => viewBooking(booking.id), type: 'outline' }
                    ]
                });
            });

            // Update UI
            updateNotificationCounts();
            renderNotifications();
        }

        function updateNotificationCounts() {
            document.getElementById('criticalCount').textContent = notifications.critical.length;
            document.getElementById('warningCount').textContent = notifications.warnings.length;
            document.getElementById('pendingCount').textContent = notifications.pending.length;
            document.getElementById('resolvedCount').textContent = notifications.resolved.length;

            document.getElementById('criticalBadge').textContent = `${notifications.critical.length} items`;
            document.getElementById('warningBadge').textContent = `${notifications.warnings.length} items`;
            document.getElementById('pendingBadge').textContent = `${notifications.pending.length} items`;
            document.getElementById('resolvedBadge').textContent = `${notifications.resolved.length} items`;

            // Update sidebar badge if available
            if (window.adminShell && window.adminShell.setNotificationBadge) {
                const totalUrgent = notifications.critical.length + notifications.warnings.length;
                window.adminShell.setNotificationBadge(totalUrgent);
            }
        }

        function renderNotifications() {
            renderSection('criticalList', notifications.critical, 'critical');
            renderSection('warningList', notifications.warnings, 'warning');
            renderSection('pendingList', notifications.pending, 'info');
            renderSection('resolvedList', notifications.resolved, 'success');
        }

        function renderSection(containerId, items, iconType) {
            const container = document.getElementById(containerId);
            
            if (items.length === 0) {
                showEmptyState(containerId, getEmptyMessage(containerId));
                return;
            }

            container.innerHTML = items.map((item, index) => `
                <div class="notification-item">
                    <div class="notification-icon ${iconType}">
                        ${getIcon(item.type)}
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${escapeHtml(item.title)}</div>
                        <div class="notification-description">${escapeHtml(item.description)}</div>
                        <div class="notification-meta">
                            <span>${formatTime(item.time)}</span>
                            ${item.meta.amount ? `<span>$${item.meta.amount}</span>` : ''}
                            ${item.meta.bookingId ? `<span>Booking #${item.meta.bookingId}</span>` : ''}
                        </div>
                    </div>
                    <div class="notification-actions">
                        ${item.actions.map((action, actionIndex) => `
                            <button class="btn btn-sm ${action.type === 'outline' ? 'btn-outline' : action.type === 'warning' ? 'btn-warning' : action.type === 'danger' ? 'btn-danger' : ''}" 
                                    onclick="executeAction('${containerId}', ${index}, ${actionIndex})">
                                ${action.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function showEmptyState(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">${getEmptyIcon(containerId)}</div>
                    <p>${message}</p>
                </div>
            `;
        }

        function getEmptyMessage(containerId) {
            switch (containerId) {
                case 'criticalList': return 'No critical issues - everything is running smoothly!';
                case 'warningList': return 'No warnings at this time';
                case 'pendingList': return 'No pending actions required';
                case 'resolvedList': return 'No items resolved today yet';
                default: return 'No items';
            }
        }

        function getEmptyIcon(containerId) {
            switch (containerId) {
                case 'criticalList': return '&#x2705;';
                case 'warningList': return '&#x1F44D;';
                case 'pendingList': return '&#x2615;';
                case 'resolvedList': return '&#x1F4CB;';
                default: return '&#x1F4E6;';
            }
        }

        function getIcon(type) {
            switch (type) {
                case 'failed_payment': return '&#x1F4B3;';
                case 'sync_failure': return '&#x1F504;';
                case 'abandoned_checkout': return '&#x1F6D2;';
                case 'pending_booking': return '&#x23F3;';
                case 'today_checkin': return '&#x1F3E0;';
                case 'today_checkout': return '&#x1F6AA;';
                case 'booking_confirmed': return '&#x2705;';
                default: return '&#x1F514;';
            }
        }

        function formatTime(timeStr) {
            if (!timeStr) return 'Unknown';
            const date = new Date(timeStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToSection(sectionId) {
            document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth' });
        }

        // Action handlers
        function executeAction(containerId, itemIndex, actionIndex) {
            let items;
            switch (containerId) {
                case 'criticalList': items = notifications.critical; break;
                case 'warningList': items = notifications.warnings; break;
                case 'pendingList': items = notifications.pending; break;
                case 'resolvedList': items = notifications.resolved; break;
            }
            
            if (items && items[itemIndex] && items[itemIndex].actions[actionIndex]) {
                items[itemIndex].actions[actionIndex].action();
            }
        }

        function viewBooking(bookingId) {
            window.location.href = `/admin-bookings.html?view=${bookingId}`;
        }

        function retryPayment(bookingId) {
            alert(`Retry payment for booking #${bookingId} - Feature coming soon!`);
        }

        async function retrySync(bookingId) {
            try {
                const response = await fetch(`/api/admin/retry-sync/${bookingId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Sync retry initiated successfully!');
                    loadNotifications();
                } else {
                    alert('Failed to retry sync. Please try again.');
                }
            } catch (error) {
                console.error('Error retrying sync:', error);
                alert('Error retrying sync. Please try again.');
            }
        }

        function sendReminder(checkoutId) {
            alert(`Send reminder for checkout #${checkoutId} - Feature coming soon!`);
        }

        function viewAbandonedCheckout(checkoutId) {
            window.location.href = `/admin-marketing.html#abandoned`;
        }

        function sendPaymentLink(bookingId) {
            alert(`Send payment link for booking #${bookingId} - Feature coming soon!`);
        }

        function sendWelcome(bookingId) {
            alert(`Send welcome message for booking #${bookingId} - Feature coming soon!`);
        }

        function requestReview(bookingId) {
            alert(`Request review for booking #${bookingId} - Feature coming soon!`);
        }

        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin.html';
        }

        // Load notifications on page load
        loadNotifications();

        // Auto-refresh every 5 minutes
        setInterval(loadNotifications, 5 * 60 * 1000);
    </script>
    <script src="/admin-shell.js?v=2"></script>
</body>
</html>
